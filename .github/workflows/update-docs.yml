name: Update Documentation

on:
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - parameters-only
          - api-only

  # Webhook from KawaiiPhysics repository
  repository_dispatch:
    types: [plugin-updated]

  # Schedule: weekly check for updates
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight UTC

jobs:
  update-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout documentation repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Clone KawaiiPhysics source
        run: |
          git clone --depth 1 https://github.com/pafuhana1213/KawaiiPhysics.git /tmp/KawaiiPhysics
          echo "PLUGIN_VERSION=$(git -C /tmp/KawaiiPhysics describe --tags --always)" >> $GITHUB_ENV

      - name: Update documentation with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Claude Code will be invoked here to analyze source and update docs
          # This requires Claude Code CLI or API integration
          echo "Analyzing KawaiiPhysics source code..."
          echo "Plugin version: $PLUGIN_VERSION"

          # Placeholder for Claude Code integration
          # npx claude-code "Based on /tmp/KawaiiPhysics source, update the documentation in ./docs"

      - name: Build documentation
        run: npm run build

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "docs: auto-update documentation for ${{ env.PLUGIN_VERSION }}"
          title: "ðŸ“š Documentation Update - ${{ env.PLUGIN_VERSION }}"
          body: |
            ## Automated Documentation Update

            This PR was automatically generated to update documentation based on the latest KawaiiPhysics source code.

            **Plugin Version**: ${{ env.PLUGIN_VERSION }}
            **Update Type**: ${{ github.event.inputs.update_type || 'full' }}

            ### Changes
            - Parameter reference updated from source UPROPERTY definitions
            - API documentation refreshed

            ### Review Checklist
            - [ ] Parameter descriptions are accurate
            - [ ] No broken links
            - [ ] Images/videos placeholders noted for manual addition

            ---
            *Generated by Claude Code Documentation Workflow*
          branch: docs/auto-update-${{ github.run_number }}
          delete-branch: true

  deploy:
    needs: update-docs
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
